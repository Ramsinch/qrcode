<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qrite.ir - مولد پیشرفته و redesigned QR Code</title>
    <link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet" type="text/css" />
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">

    <script type="text/javascript" src="qr-code-styling.js"></script>
    <script src="jsQR.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        :root {
            --primary-color: #4A90E2;
            --primary-hover: #357ABD;
            --background-color: #F4F7FC;
            --panel-bg: #FFFFFF;
            --text-primary: #333D47;
            --text-secondary: #7A8C99;
            --border-color: #E6EAF0;
            --danger-color: #D0021B;
            --success-color: #4CAF50;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            --border-radius: 12px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Vazir', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
        }

        .app-wrapper {
            display: flex;
            width: 100%;
        }

        /* --- Sidebar (Navigation) --- */
        .sidebar {
            width: 80px;
            background-color: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: width 0.3s ease;
            z-index: 100;
        }
        .sidebar-logo {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-color);
            margin-bottom: 40px;
        }
        .nav-list {
            list-style: none;
            width: 100%;
        }
        .nav-item button {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 0;
            border: none;
            background-color: transparent;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease;
        }
        .nav-item button svg {
            width: 26px;
            height: 26px;
            fill: var(--text-secondary);
            transition: fill 0.2s ease;
        }
        .nav-item button.active svg {
            fill: var(--primary-color);
        }
        .nav-item button.active::before {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background-color: var(--primary-color);
            border-radius: 4px 0 0 4px;
        }
        .nav-item button:hover svg {
            fill: var(--primary-hover);
        }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        .view-content { display: none; }
        .view-content.active { display: block; }
        
        .page-header h1 {
            font-size: 28px;
            margin-bottom: 20px;
            text-align: right;
        }
        .content-grid {
            display: grid;
            gap: 30px;
        }

        .card {
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            margin-bottom: 25px;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* --- Generator Specific Styles --- */
        #generator-grid {
             grid-template-columns: minmax(280px, 1fr) minmax(350px, 1.5fr) minmax(300px, 1fr);
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-family: 'Vazir';
            color: var(--text-secondary);
            position: relative;
        }
        .tab-button.active {
            color: var(--primary-color);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        textarea, input[type="text"], input[type="url"], input[type="password"], select {
            width: 100%; padding: 15px; font-size: 16px; font-family: 'Vazir';
            border-radius: 8px; border: 1px solid var(--border-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus, input:focus, select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        
        .form-section { margin-top: 30px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .option-item { margin-bottom: 15px; }
        .option-item label { display: block; font-size: 14px; margin-bottom: 8px; color: var(--text-secondary); }

        .logo-uploader {
            padding: 15px; border: 2px dashed var(--border-color); border-radius: 8px;
            text-align: center; cursor: pointer; transition: border-color 0.2s;
        }
        .logo-uploader:hover { border-color: var(--primary-color); }
        #logo-input { display: none; }
        .logo-preview-container {
            display: none; align-items: center; gap: 15px;
            padding: 10px; background-color: #F9FAFB; border-radius: 8px;
        }
        .logo-preview-container img { width: 50px; height: 50px; object-fit: contain; }
        .logo-preview-container span { flex-grow: 1; text-align: right; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        #remove-logo-btn {
            background: none; border: none; cursor: pointer; padding: 4px;
        }
        #remove-logo-btn:hover svg { fill: var(--danger-color); }
        
        /* Viewer Styles */
        .viewer-card { text-align: center; }
        #qrcode-container {
            background: white; padding: 15px; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); display: flex;
            align-items: center; justify-content: center; min-height: 280px;
        }
        .button-group { display: flex; flex-wrap:wrap; gap: 10px; margin-top: 25px; }
        .btn {
            flex-grow: 1; padding: 12px 15px; font-size: 15px; font-family: 'Vazir';
            border: none; border-radius: 8px; cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #E6EAF0; color: var(--text-primary); }
        .btn-secondary:hover:not(:disabled) { background-color: #D9DEE6; }
        .btn:disabled { background-color: #f0f0f0; color: #aaa; cursor: not-allowed; }

        /* History Styles */
        .history-panel { grid-column: 1 / -1; }
        #history-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .history-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .history-item:hover { background-color: #f8f9fa; }
        .history-item .preview { width: 40px; height: 40px; border-radius: 4px; margin-left: 10px; flex-shrink: 0; }
        .history-item .info { flex-grow: 1; overflow: hidden; }
        .history-item .info span { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; }
        .history-item .timestamp { font-size: 12px; color: var(--text-secondary); }
        .history-item .delete-btn { background: none; border: none; cursor: pointer; padding: 5px; flex-shrink: 0; }
        .history-item .delete-btn:hover svg { fill: var(--danger-color); }
        .placeholder-text { text-align: center; padding: 20px; color: var(--text-secondary); }

        /* --- Responsive Design --- */
        @media (max-width: 1200px) {
            #generator-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .app-wrapper { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: 60px; flex-direction: row; justify-content: space-around; border-top: 1px solid var(--border-color); border-left: none; }
            .sidebar-logo { display: none; }
            .nav-item button.active::before { width: 60%; height: 3px; top: 0; right: 50%; transform: translateX(50%); border-radius: 0 0 3px 3px; }
            .main-content { padding: 15px; }
            #generator-grid { grid-template-columns: 1fr; }
            .card { padding: 20px; }
            .page-header h1 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <aside class="sidebar">
            <div class="sidebar-logo">Qrite.ir</div>
            <ul class="nav-list">
                <li class="nav-item">
                    <button class="nav-button active" data-view="generator-view" title="تولید کننده">
                        <svg viewBox="0 0 24 24"><path d="M4,4H10V10H4V4M20,4V10H14V4H20M14,15H20V20H14V15M4,20V14H10V20H4M6,6V8H8V6H6M16,6V8H18V6H16M16,17V19H18V17H16M6,16V18H8V16H6M11,6H13V13H11V6M11,15H13V20H11V15Z"/></svg>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-button" data-view="reader-view" title="خواننده">
                        <svg viewBox="0 0 24 24"><path d="M16.5,14H17.5V17H16.5V14M16.5,10H17.5V13H16.5V10M14.5,14H15.5V17H14.5V14M14.5,10H15.5V13H14.5V10M13.5,17H10.5V15.5H13.5V17M13.5,12.5H10.5V11H13.5V12.5M3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3H5A2,2 0 0,0 3,5M5,5H19V19H5V5Z"/></svg>
                    </button>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <div id="generator-view" class="view-content active">
                <header class="page-header"><h1>تولید کننده پیشرفته QR Code</h1></header>
                <div id="generator-grid" class="content-grid">
                    
                    <div class="card">
                        <div class="card-header">نوع محتوا</div>
                        <div class="tabs">
                            <button class="tab-button active" data-tab="text-tab">متن</button>
                            <button class="tab-button" data-tab="url-tab">لینک</button>
                            <button class="tab-button" data-tab="wifi-tab">Wi-Fi</button>
                            <button class="tab-button" data-tab="vcard-tab">vCard</button>
                        </div>
                        <div id="text-tab" class="tab-content active">
                            <textarea id="text-input" rows="5" placeholder="متن خود را اینجا وارد کنید..."></textarea>
                        </div>
                        <div id="url-tab" class="tab-content">
                            <input type="url" id="url-input" placeholder="https://example.com">
                        </div>
                        <div id="wifi-tab" class="tab-content">
                            <div class="option-item">
                                <label for="wifi-ssid">نام شبکه (SSID)</label>
                                <input type="text" id="wifi-ssid">
                            </div>
                            <div class="option-item">
                                <label for="wifi-password">رمز عبور</label>
                                <input type="password" id="wifi-password">
                            </div>
                            <div class="option-item">
                                <label for="wifi-encryption">نوع رمزنگاری</label>
                                <select id="wifi-encryption">
                                    <option value="WPA">WPA/WPA2</option>
                                    <option value="WEP">WEP</option>
                                    <option value="nopass">بدون رمز</option>
                                </select>
                            </div>
                        </div>
                        <div id="vcard-tab" class="tab-content">
                            <div class="option-item">
                                <label for="vcard-name">نام و نام خانوادگی</label>
                                <input type="text" id="vcard-name">
                            </div>
                            <div class="option-item">
                                <label for="vcard-phone">تلفن</label>
                                <input type="text" id="vcard-phone">
                            </div>
                            <div class="option-item">
                                <label for="vcard-email">ایمیل</label>
                                <input type="text" id="vcard-email">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">شخصی‌سازی</div>
                        <div class="options-grid">
                            <div class="option-item">
                                <label for="dot-style">استایل نقطه‌ها</label>
                                <select id="dot-style">
                                    <option value="square">مربعی</option>
                                    <option value="dots">نقطه‌ای</option>
                                    <option value="rounded">گرد</option>
                                </select>
                            </div>
                            <div class="option-item">
                                <label for="correction-level">سطح تصحیح خطا</label>
                                <select id="correction-level">
                                    <option value="L">پایین</option>
                                    <option value="M" selected>متوسط</option>
                                    <option value="Q">بالا</option>
                                    <option value="H">بسیار بالا</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-section">
                            <label class="option-item" for="logo-uploader">لوگو</label>
                            <label for="logo-input" id="logo-uploader" class="logo-uploader"><span>برای آپلود لوگو کلیک کنید</span></label>
                            <input type="file" id="logo-input" accept="image/*">
                            <div class="logo-preview-container" id="logo-preview">
                                <img id="logo-preview-image" src="" alt="پیش‌نمایش لوگو">
                                <span id="logo-preview-name"></span>
                                <button id="remove-logo-btn" title="حذف لوگو"><svg viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg></button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card viewer-card">
                         <div class="card-header">پیش‌نمایش</div>
                         <div id="qrcode-container"><p class="placeholder-text">کد شما اینجا نمایش داده می‌شود</p></div>
                         <div class="button-group">
                            <button id="download-png-btn" class="btn btn-primary" disabled>دانلود PNG</button>
                            <button id="download-svg-btn" class="btn btn-secondary" disabled>دانلود SVG</button>
                         </div>
                    </div>
                    
                    <div class="card history-panel">
                        <div class="card-header">تاریخچه</div>
                        <ul id="history-list"><p class="placeholder-text">تاریخچه‌ای یافت نشد.</p></ul>
                    </div>
                </div>
            </div>

            <div id="reader-view" class="view-content">
                 <header class="page-header"><h1>خواندن QR Code</h1></header>
                 <div class="card full-width-card">
                     <div class="button-group" style="justify-content:center; margin-top:0; margin-bottom:20px;">
                         <label for="file-input-reader" class="btn btn-primary">آپلود تصویر</label>
                         <input type="file" id="file-input-reader" accept="image/*" style="display:none;">
                         <button id="camera-btn" class="btn btn-secondary">استفاده از وب‌کم</button>
                     </div>
                     <div id="video-container" style="display:none; border-radius: var(--border-radius); overflow:hidden;"><video id="video-feed" playsinline></video></div>
                     <div id="reader-results" style="margin-top:20px;"><h3>نتیجه اسکن:</h3><div id="decoded-data"><p class="placeholder-text">منتظر اسکن یا آپلود تصویر...</p></div></div>
                 </div>
            </div>
            <footer style="text-align: center; padding: 20px; color: var(--text-secondary);">طراحی و توسعه توسط <a href="https://www.linkedin.com/in/ramsinchaabian/" target="_blank">رامسین چعبیان</a></footer>
        </main>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const qrcodeContainer = document.getElementById('qrcode-container');
        const textInput = document.getElementById('text-input');
        const urlInput = document.getElementById('url-input');
        const wifiSsidInput = document.getElementById('wifi-ssid');
        const wifiPasswordInput = document.getElementById('wifi-password');
        const wifiEncryptionSelect = document.getElementById('wifi-encryption');
        const vcardNameInput = document.getElementById('vcard-name');
        const vcardPhoneInput = document.getElementById('vcard-phone');
        const vcardEmailInput = document.getElementById('vcard-email');

        const dotStyleSelect = document.getElementById('dot-style');
        const correctionLevelSelect = document.getElementById('correction-level');
        const logoInput = document.getElementById('logo-input');
        const removeLogoBtn = document.getElementById('remove-logo-btn');
        const downloadPngBtn = document.getElementById('download-png-btn');
        const downloadSvgBtn = document.getElementById('download-svg-btn');
        
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        let activeTab = 'text-tab';
        let logoImageBase64 = null;
        let qrCode = null;
        let qrCodeUpdateDebounce = null;
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                if (targetTab === activeTab) return;
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(targetTab).classList.add('active');
                
                activeTab = targetTab;
                handleStateChange();
            });
        });

        const getQrData = () => {
            switch (activeTab) {
                case 'url-tab':
                    return urlInput.value;
                case 'wifi-tab':
                    const ssid = wifiSsidInput.value;
                    const password = wifiPasswordInput.value;
                    const encryption = wifiEncryptionSelect.value;
                    return `WIFI:T:${encryption};S:${ssid};P:${password};;`;
                case 'vcard-tab':
                    const name = vcardNameInput.value;
                    const phone = vcardPhoneInput.value;
                    const email = vcardEmailInput.value;
                    return `BEGIN:VCARD\nVERSION:3.0\nN:${name}\nTEL:${phone}\nEMAIL:${email}\nEND:VCARD`;
                case 'text-tab':
                default:
                    return textInput.value;
            }
        };

        const generateOrUpdateQRCode = () => {
            const data = getQrData().trim();

            if (!data) {
                qrcodeContainer.innerHTML = '<p class="placeholder-text">کد شما اینجا نمایش داده می‌شود</p>';
                downloadPngBtn.disabled = true;
                downloadSvgBtn.disabled = true;
                qrCode = null;
                return;
            }

            const options = {
                width: 250,
                height: 250,
                data: data,
                image: logoImageBase64,
                dotsOptions: {
                    type: dotStyleSelect.value,
                    color: '#000'
                },
                qrOptions: {
                    errorCorrectionLevel: correctionLevelSelect.value
                },
                imageOptions: {
                    crossOrigin: 'anonymous',
                    margin: 4
                }
            };
            
            if (!logoImageBase64) delete options.image;

            qrcodeContainer.innerHTML = '';
            try {
                qrCode = new QRCodeStyling(options);
                qrCode.append(qrcodeContainer);
                downloadPngBtn.disabled = false;
                downloadSvgBtn.disabled = false;
                saveToHistory(data);
            } catch (error) {
                qrcodeContainer.innerHTML = '<p class="placeholder-text" style="color:var(--danger-color);">خطا: متن بیش از حد طولانی است.</p>';
                downloadPngBtn.disabled = true;
                downloadSvgBtn.disabled = true;
                qrCode = null;
            }
        };

        const handleStateChange = () => {
            clearTimeout(qrCodeUpdateDebounce);
            qrCodeUpdateDebounce = setTimeout(generateOrUpdateQRCode, 300);
        };

        const handleLogoUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    logoImageBase64 = event.target.result;
                    document.getElementById('logo-uploader').style.display = 'none';
                    document.getElementById('logo-preview').style.display = 'flex';
                    document.getElementById('logo-preview-image').src = logoImageBase64;
                    document.getElementById('logo-preview-name').textContent = file.name;
                    handleStateChange();
                };
                reader.readAsDataURL(file);
            }
        };

        removeLogoBtn.addEventListener('click', () => {
            logoImageBase64 = null;
            logoInput.value = '';
            document.getElementById('logo-uploader').style.display = 'block';
            document.getElementById('logo-preview').style.display = 'none';
            handleStateChange();
        });

        const getHistory = () => JSON.parse(localStorage.getItem('qrHistory_v3') || '[]');
        const saveHistory = (history) => localStorage.setItem('qrHistory_v3', JSON.stringify(history));

        const saveToHistory = (data) => {
            if (!data) return;
            let history = getHistory();
            const newItem = {
                data: data,
                timestamp: new Date().toLocaleString('fa-IR')
            };
            const existingIndex = history.findIndex(item => item.data === data);
            if (existingIndex > -1) history.splice(existingIndex, 1);
            history.unshift(newItem);
            if (history.length > 10) history = history.slice(0, 10);
            saveHistory(history);
            renderHistory();
        };

        const renderHistory = () => {
            const historyList = document.getElementById('history-list');
            const history = getHistory();
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = '<p class="placeholder-text">تاریخچه‌ای یافت نشد.</p>';
            } else {
                history.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.dataset.index = index;
                    li.innerHTML = `
                        <div class="preview"></div>
                        <div class="info">
                            <span>${item.data.substring(0, 50)}...</span>
                            <span class="timestamp">${item.timestamp}</span>
                        </div>
                        <button class="delete-btn" title="حذف"><svg viewBox="0 0 24 24" width="18" height="18" fill="#999"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg></button>
                    `;
                    historyList.appendChild(li);
                    const previewOptions = { width: 40, height: 40, data: item.data };
                    new QRCodeStyling(previewOptions).append(li.querySelector('.preview'));
                });
            }
        };
        
        historyList.addEventListener('click', (e) => {
            const itemLi = e.target.closest('.history-item');
            if (!itemLi) return;
            const index = itemLi.dataset.index;
            if (e.target.closest('.delete-btn')) {
                e.stopPropagation();
                let history = getHistory();
                history.splice(index, 1);
                saveHistory(history);
                renderHistory();
            } else {
                const item = getHistory()[index];
                textInput.value = item.data; // Simple restore, can be improved
                document.querySelector('.tab-button[data-tab="text-tab"]').click();
                handleStateChange();
            }
        });

        // Event Listeners
        [textInput, urlInput, wifiSsidInput, wifiPasswordInput, vcardNameInput, vcardPhoneInput, vcardEmailInput].forEach(input => {
            input.addEventListener('input', handleStateChange);
        });
        [dotStyleSelect, correctionLevelSelect, wifiEncryptionSelect].forEach(select => {
            select.addEventListener('change', handleStateChange);
        });
        logoInput.addEventListener('change', handleLogoUpload);
        
        downloadPngBtn.addEventListener('click', () => qrCode?.download({ name: 'qrite-qrcode', extension: 'png' }));
        downloadSvgBtn.addEventListener('click', () => qrCode?.download({ name: 'qrite-qrcode', extension: 'svg' }));

        // --- Navigation ---
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', () => {
                const targetView = button.dataset.view;
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.view-content').forEach(view => view.classList.remove('active'));
                document.getElementById(targetView).classList.add('active');
            });
        });
        
        // Initial calls
        generateOrUpdateQRCode();
        renderHistory();
    });
    </script>
</body>
</html>
